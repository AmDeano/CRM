@model CRM.Models.Project
@{
    ViewData["Title"] = "Project Details";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@Model.Name</h2>
        <div>
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Edit Project</a>
            <a asp-action="Index" class="btn btn-secondary">Back to List</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Project Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Client</dt>
                        <dd class="col-sm-9">
                            <a asp-controller="Clients" asp-action="Details" asp-route-id="@Model.ClientId">
                                @Model.Client?.Name
                            </a>
                        </dd>

                        <dt class="col-sm-3">Description</dt>
                        <dd class="col-sm-9">@Model.Description</dd>

                        <dt class="col-sm-3">Status</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-info fs-6">@Model.Status</span>
                        </dd>

                        <dt class="col-sm-3">Start Date</dt>
                        <dd class="col-sm-9">@Model.StartDate.ToString("MMMM dd, yyyy")</dd>

                        <dt class="col-sm-3">End Date</dt>
                        <dd class="col-sm-9">@(Model.EndDate?.ToString("MMMM dd, yyyy") ?? "Not set")</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Progress</h5>
                </div>
                <div class="card-body text-center">
                    <h1 class="display-4">@Model.Progress%</h1>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @Model.Progress%"
                             aria-valuenow="@Model.Progress" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <p class="mt-3 mb-0">
                        <strong>@Model.Tasks?.Count(t => t.IsCompleted)</strong> of
                        <strong>@Model.Tasks?.Count()</strong> tasks completed
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Tasks (@Model.Tasks?.Count())</h5>
            <a asp-controller="Tasks" asp-action="Create" asp-route-projectId="@Model.Id" class="btn btn-sm btn-success">
                <i class="bi bi-plus"></i> Add Task
            </a>
        </div>
        <div class="card-body">
            @if (Model.Tasks != null && Model.Tasks.Any())
            {
                <div class="list-group">
                    @foreach (var task in Model.Tasks.OrderBy(t => t.IsCompleted).ThenByDescending(t => t.Priority))
                    {
                        <div class="list-group-item @(task.IsCompleted ? "bg-light" : "")">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 @(task.IsCompleted ? "text-decoration-line-through text-muted" : "")">
                                    @task.Title
                                </h6>
                                <div>
                                    <span class="badge @(task.Priority == CRM.Models.TaskPriority.Urgent ? "bg-danger" :
                                                                                                   task.Priority == CRM.Models.TaskPriority.High ? "bg-warning" :
                                                                                                   task.Priority == CRM.Models.TaskPriority.Medium ? "bg-info" : "bg-secondary")">
                                        @task.Priority
                                    </span>
                                    @if (task.IsCompleted)
                                    {
                                        <span class="badge bg-success">Completed</span>
                                    }
                                </div>
                            </div>
                            <p class="mb-1">@task.Description</p>
                            <small class="text-muted">
                                Due: @(task.DueDate != null ? task.DueDate.ToShortDateString() : "No due date")
                            </small>
                            <div class="mt-2">
                                <form asp-controller="Tasks" asp-action="ToggleComplete" asp-route-id="@task.Id"
                                      method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm @(task.IsCompleted ? "btn-outline-secondary" : "btn-outline-success")">
                                        <i class="bi bi-check-circle"></i> @(task.IsCompleted ? "Mark Incomplete" : "Mark Complete")
                                    </button>
                                </form>
                                <a asp-controller="Tasks" asp-action="Edit" asp-route-id="@task.Id"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted">No tasks yet for this project.</p>
            }
        </div>
    </div>
</div>